/**
 * Potential user selector module.
 *
 * @module     enrol_manual/form-potential-user-selector
 * @copyright  2016 Damyon Wiese
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_business/get_all_courses", ["jquery", "core/ajax", "core/templates", "core/str"], function ($, Ajax, Templates, Str) {
    // console.log('testttt');
    return {
        processResults: function (selector, results) {
            var courses = [];
            return $.isArray(results)
                ? ($.each(results, function (index, course) {
                      courses.push({ value: course.id, label: course.name });
                  }),
                  courses)
                : results;
        },
        transport: function (selector, query, success, failure) {
            var perpage = parseInt($(selector).attr("perpage"));
            isNaN(perpage) && (perpage = 100),
                Ajax.call([{ methodname: "local_business_get_all_courses", args: { search: query, page: 0, perpage: perpage } }])[0]
                    .then(function (results) {
                        var promises = [],
                            i = 0;
                        if (results.length <= perpage) {
                            return (
                                $.each(results, function (index, course) {
                                    console.log('course',course);
                                    var ctx = course;
                                    promises.push(Templates.render("enrol_manual/form-user-selector-suggestion", ctx));
                                }),
                                $.when.apply($.when, promises).then(function () {
                                    var args = arguments;
                                    $.each(results, function (index, course) {
                                        (course._label = args[i]), i++;
                                    }),
                                        success(results);
                                })
                            );
                        }
                        return Str.get_string("toomanyuserstoshow", "core", ">" + perpage).then(function (toomanyuserstoshow) {
                            success(toomanyuserstoshow);
                        });
                    })
                    .fail(failure);
        },
    };
});
